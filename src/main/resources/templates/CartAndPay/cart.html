<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cart - LibBooks</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="/css/cart-styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
</head>
<body class="cart-content">
<main class="wrapper">
  <main class="main">
    <nav class="breadcrumb">
      <a href="/home">Trang chủ</a>
      <i class="ri-arrow-right-s-line"></i>
      <span>Giỏ hàng</span>
    </nav>
    <div class="page-header">
      <h1>Giỏ hàng của bạn</h1>
      <p>Xem lại và hoàn tất đơn hàng</p>
    </div>
    <div class="cart-layout">
      <div class="cart-section">
        <div class="cart-header">
          <h2>Sản phẩm trong giỏ</h2>
          <button class="clear-cart-btn" onclick="clearCart()">
            <i class="ri-delete-bin-line"></i>
            Xóa tất cả
          </button>
        </div>
        <div class="cart-items" id="cartItems"></div>
        <div class="empty-cart" id="emptyCart" style="display: none">
          <div class="empty-icon">
            <i class="ri-shopping-cart-line"></i>
          </div>
          <h3>Giỏ hàng của bạn đang trống</h3>
          <p>Hãy khám phá và thêm những cuốn sách yêu thích vào giỏ hàng</p>
          <a href="/home" class="btn btn-primary">
            <i class="ri-book-open-line"></i>
            Khám phá sách
          </a>
        </div>
      </div>
      <div class="summary-section">
        <div class="order-summary">
          <h2>Tóm tắt đơn hàng</h2>
          <div class="summary-row">
            <span>Tạm tính (<span id="itemCount">${totalItems}</span> sản phẩm):</span>
            <span id="subtotal">${subtotal} VNĐ</span>
          </div>
          <div class="summary-row">
            <span>Giảm giá:</span>
            <span class="discount-amount">-${discount} VNĐ</span>
          </div>
          <div class="summary-row">
            <span>Phí vận chuyển:</span>
            <span id="shippingFee">${shippingFee} VNĐ</span>
          </div>
          <div class="summary-row">
            <span>Thuế VAT (10%):</span>
            <span id="tax">${tax} VNĐ</span>
          </div>
          <div class="summary-divider"></div>
          <div class="summary-row total-row">
            <span>Tổng cộng:</span>
            <span id="totalAmount">${totalAmount} VNĐ</span>
          </div>
          <div class="promo-section">
            <h4>Mã giảm giá</h4>
            <form class="promo-form" id="promoForm">
              <div class="promo-input-group">
                <input type="text" id="promoCode" placeholder="Nhập mã giảm giá" maxlength="20" />
                <button type="submit" class="apply-btn">Áp dụng</button>
              </div>
            </form>
            <div class="applied-promos" id="appliedPromos"></div>
          </div>
          <button class="checkout-btn" onclick="proceedToCheckout()">
            <i class="ri-lock-line"></i>
            Tiến hành thanh toán
          </button>
          <div class="security-badge">
            <i class="ri-shield-check-line"></i>
            <span>Thanh toán an toàn & bảo mật</span>
          </div>
        </div>
        <div id="shippingSection" class="shipping-section" style="display: none;">
          <div class="shipping-form">
            <h3>Thông tin giao hàng</h3>
            <form id="shippingForm">
              <div class="form-row">
                <div class="form-group">
                  <label for="fullName">Họ và tên</label>
                  <input type="text" id="fullName" name="fullName" required />
                </div>
                <div class="form-group">
                  <label for="phone">Số điện thoại</label>
                  <input type="tel" id="phone" name="phone" required />
                </div>
              </div>
              <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" name="email" required />
              </div>
              <div class="form-group">
                <label for="address">Địa chỉ</label>
                <input type="text" id="address" name="address" required />
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label for="province">Tỉnh/Thành phố</label>
                  <select id="province" name="province" required>
                    <option value="">Chọn tỉnh/thành</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="district">Quận/Huyện</label>
                  <select id="district" name="district" required>
                    <option value="">Chọn quận/huyện</option>
                  </select>
                </div>
              </div>
              <div class="shipping-options">
                <h4>Phương thức vận chuyển</h4>
                <div class="shipping-option">
                  <input type="radio" id="standard" name="shippingMethod" value="standard" checked onchange="updateShippingFee()" />
                  <label for="standard">
                    <div class="option-info">
                      <span class="option-name">Giao hàng tiêu chuẩn</span>
                      <span class="option-time">3-5 ngày</span>
                    </div>
                    <span class="option-price">10,000 VNĐ</span>
                  </label>
                </div>
                <div class="shipping-option">
                  <input type="radio" id="express" name="shippingMethod" value="express" onchange="updateShippingFee()" />
                  <label for="express">
                    <div class="option-info">
                      <span class="option-name">Giao hàng nhanh</span>
                      <span class="option-time">1-2 ngày</span>
                    </div>
                    <span class="option-price">30,000 VNĐ</span>
                  </label>
                </div>
              </div>
              <div class="form-group">
                <label for="note">Ghi chú</label>
                <textarea id="note" name="note"></textarea>
              </div>
              <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="backToSummary()">Quay lại</button>
                <button type="submit" class="btn btn-primary">Xác nhận đơn hàng</button>
              </div>
            </form>
          </div>
          <div class="payment-section">
            <h3>Phương thức thanh toán</h3>
            <div class="payment-options">
              <div class="payment-option">
                <input type="radio" id="cod" name="paymentMethod" value="cod" checked />
                <label for="cod">
                  <div class="payment-icon">
                    <i class="ri-cash-line"></i>


                  </div>
                  <div class="payment-info">
                    <span class="payment-name">Thanh toán khi nhận hàng (COD)</span>
                    <span class="payment-desc">Thanh toán bằng tiền mặt khi nhận hàng</span>
                  </div>
                </label>
              </div>
              <!--              <div class="payment-option">-->
              <!--                <input type="radio" id="vnpay" name="paymentMethod" value="vnpay" />-->
              <!--                <label for="vnpay">-->
              <!--                  <div class="payment-icon">-->
              <!--                    <i class="ri-bank-card-line"></i>-->
              <!--                  </div>-->
              <!--                  <div class="payment-info">-->
              <!--                    <span class="payment-name">VNPay</span>-->
              <!--                    <span class="payment-desc">Thanh toán qua thẻ ATM, Visa, MasterCard</span>-->
              <!--                  </div>-->
              <!--                </label>-->
              <!--              </div>-->
              <div class="payment-option">
                <input type="radio" id="bank_transfer" name="paymentMethod" value="bank_transfer" />
                <label for="bank_transfer">
                  <div class="payment-icon">
                    <i class="ri-qr-code-line"></i>
                  </div>
                  <div class="payment-info">
                    <span class="payment-name">Chuyển khoản ngân hàng</span>
                    <span class="payment-desc">Quét mã QR hoặc chuyển khoản thủ công</span>
                  </div>
                </label>
              </div>
            </div>
            <div id="bankTransferContainer" class="bank-transfer-container" style="display: none;">
              <h4 id="paymentTitle" class="gradient-text">Vui lòng quét mã QR để thanh toán</h4>
              <div class="qr-container">
                <div class="qr-card">
                  <img id="qrCode" class="qr-img" src="" alt="QR Code" />
                </div>
                <p class="vnd-coin">Số tiền: <span id="totalAmountQR">${totalAmount} VNĐ</span></p>
                <p class="content-transfer">
                  Nội dung chuyển khoản: <span id="transferContent"></span>
                  <button onclick="copyToClipboard(document.getElementById('transferContent').textContent)" class="btn btn-secondary">
                    <i class="ri-file-copy-line"></i> Sao chép
                  </button>
                </p>
                <p class="note-text">Vui lòng nhập đúng nội dung chuyển khoản để xác nhận thanh toán</p>
              </div>
              <div class="manual-verification">
                <input type="text" id="transactionCode" placeholder="Nhập mã giao dịch (nếu có)" />
                <button class="btn btn-primary" onclick="verifyTransaction()">Xác minh</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="recommendations">
      <h2>Có thể bạn quan tâm</h2>
      <div class="recommended-grid" id="recommendedProducts">
        <div class="product-card">
          <div class="product-image">
            <img src="${book.ImageFile}" alt="Book Title" />
            <button class="quick-add-btn">
              <i class="ri-add-line"></i>
            </button>
          </div>
          <div class="product-info">
            <h4>${book.title}</h4>
            <p>${book.author}</p>
            <div class="product-price">
              <span class="current">${book.price} VNĐ</span>
              <span class="original">${book.originalPrice} VNĐ</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div th:include="fragments/footer :: footer"></div>
    <div class="loading-overlay" id="loadingOverlay">
      <div class="loading-spinner"></div>
    </div>
    <div class="toast-container" id="toastContainer"></div>
    <div class="modal fade" id="confirmModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalTitle">Xác nhận</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p id="modalMessage">Bạn có chắc chắn muốn thực hiện hành động này?</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
            <button type="button" class="btn btn-primary" id="modalConfirm">Xác nhận</button>
          </div>
        </div>
      </div>
    </div>
  </main>
</main>
<script th:inline="javascript">
  let userInSession = /*[[${session.USER}]]*/ null;
  console.log("User object từ session:", userInSession);
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
<script src="/js/cart-script.js"></script>
<script src="/js/address-handler.js"></script>
</body>
</html>